<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Movie Player</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/hls.js/1.4.12/hls.min.js"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
    
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      background: #000;
      color: white;
      font-family: 'Inter', Arial, sans-serif;
      overflow: hidden;
      position: relative;
    }

    .player-container {
      position: relative;
      width: 100vw;
      height: 100vh;
      background: #000;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    #videoPlayer {
      width: 100%;
      height: 100%;
      object-fit: contain;
      background: #000;
    }

    .loading-screen {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(135deg, #0c0c0c 0%, #1a1a2e 50%, #16213e 100%);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 100;
      transition: opacity 0.5s ease;
    }

    .loading-screen.hidden {
      opacity: 0;
      pointer-events: none;
    }

    .loading-spinner {
      width: 60px;
      height: 60px;
      border: 4px solid rgba(255, 255, 255, 0.1);
      border-top: 4px solid #a78bfa;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: 20px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .loading-text {
      font-size: 18px;
      color: rgba(255, 255, 255, 0.8);
      margin-bottom: 10px;
    }

    .movie-info {
      text-align: center;
      max-width: 600px;
      padding: 0 20px;
    }

    .movie-title {
      font-size: 24px;
      font-weight: 600;
      margin-bottom: 8px;
      background: linear-gradient(135deg, #fff 0%, #a78bfa 50%, #ec4899 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .movie-details {
      font-size: 14px;
      color: rgba(255, 255, 255, 0.6);
    }

    .controls-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.3);
      opacity: 0;
      transition: opacity 0.3s ease;
      pointer-events: none;
      z-index: 50;
    }

    .controls-overlay.show {
      opacity: 1;
      pointer-events: auto;
    }

    .top-controls {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      padding: 20px;
      background: linear-gradient(to bottom, rgba(0, 0, 0, 0.8), transparent);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .back-button {
      display: flex;
      align-items: center;
      gap: 8px;
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
      color: white;
      padding: 8px 16px;
      border-radius: 20px;
      cursor: pointer;
      transition: all 0.3s ease;
      backdrop-filter: blur(10px);
      text-decoration: none;
      font-size: 14px;
    }

    .back-button:hover {
      background: rgba(255, 255, 255, 0.2);
      border-color: rgba(167, 139, 250, 0.6);
    }

    .video-info {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      text-align: right;
    }

    .video-title {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 4px;
    }

    .video-details {
      font-size: 12px;
      color: rgba(255, 255, 255, 0.7);
    }

    .center-controls {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      display: flex;
      align-items: center;
      gap: 20px;
    }

    .play-pause-btn {
      width: 80px;
      height: 80px;
      background: rgba(255, 255, 255, 0.9);
      border: none;
      border-radius: 50%;
      color: #333;
      font-size: 24px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
      backdrop-filter: blur(10px);
    }

    .play-pause-btn:hover {
      background: rgba(255, 255, 255, 1);
      transform: scale(1.1);
    }

    .skip-btn {
      width: 50px;
      height: 50px;
      background: rgba(255, 255, 255, 0.7);
      border: none;
      border-radius: 50%;
      color: #333;
      font-size: 16px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
      backdrop-filter: blur(10px);
    }

    .skip-btn:hover {
      background: rgba(255, 255, 255, 0.9);
      transform: scale(1.1);
    }

    .bottom-controls {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      padding: 20px;
      background: linear-gradient(to top, rgba(0, 0, 0, 0.8), transparent);
    }

    .progress-container {
      margin-bottom: 15px;
    }

    .progress-bar {
      width: 100%;
      height: 6px;
      background: rgba(255, 255, 255, 0.3);
      border-radius: 3px;
      cursor: pointer;
      position: relative;
      overflow: hidden;
    }

    .progress-filled {
      height: 100%;
      background: linear-gradient(90deg, #a78bfa, #ec4899);
      width: 0%;
      transition: width 0.1s ease;
      border-radius: 3px;
    }

    .progress-buffered {
      position: absolute;
      top: 0;
      left: 0;
      height: 100%;
      background: rgba(255, 255, 255, 0.2);
      width: 0%;
      border-radius: 3px;
    }

    .control-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .left-controls, .right-controls {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .control-btn {
      background: none;
      border: none;
      color: white;
      font-size: 18px;
      cursor: pointer;
      padding: 8px;
      border-radius: 4px;
      transition: all 0.3s ease;
    }

    .control-btn:hover {
      background: rgba(255, 255, 255, 0.1);
      transform: scale(1.1);
    }

    .time-display {
      font-size: 14px;
      color: rgba(255, 255, 255, 0.8);
      min-width: 100px;
    }

    .volume-container {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .volume-slider {
      width: 80px;
      height: 4px;
      background: rgba(255, 255, 255, 0.3);
      border-radius: 2px;
      cursor: pointer;
      position: relative;
    }

    .volume-filled {
      height: 100%;
      background: linear-gradient(90deg, #a78bfa, #ec4899);
      border-radius: 2px;
      width: 100%;
      transition: width 0.1s ease;
    }

    .quality-selector {
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
      color: white;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
      cursor: pointer;
    }

    .error-screen {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(135deg, #0c0c0c 0%, #1a1a2e 50%, #16213e 100%);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 200;
      display: none;
    }

    .error-icon {
      font-size: 4rem;
      margin-bottom: 20px;
      opacity: 0.6;
    }

    .error-title {
      font-size: 24px;
      font-weight: 600;
      margin-bottom: 10px;
    }

    .error-message {
      font-size: 16px;
      color: rgba(255, 255, 255, 0.7);
      text-align: center;
      max-width: 500px;
      margin-bottom: 30px;
      line-height: 1.5;
    }

    .retry-button {
      background: linear-gradient(135deg, #a78bfa, #ec4899);
      border: none;
      color: white;
      padding: 12px 24px;
      border-radius: 20px;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .retry-button:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 20px rgba(167, 139, 250, 0.3);
    }

    /* Mobile optimizations */
    @media (max-width: 768px) {
      .top-controls {
        padding: 15px;
      }

      .video-title {
        font-size: 16px;
      }

      .video-details {
        font-size: 11px;
      }

      .play-pause-btn {
        width: 60px;
        height: 60px;
        font-size: 20px;
      }

      .skip-btn {
        width: 40px;
        height: 40px;
        font-size: 14px;
      }

      .bottom-controls {
        padding: 15px;
      }

      .control-row {
        flex-wrap: wrap;
        gap: 10px;
      }

      .left-controls, .right-controls {
        gap: 10px;
      }

      .volume-container {
        display: none; /* Hide volume on mobile */
      }

      .control-btn {
        font-size: 16px;
        padding: 6px;
      }
    }

    /* Hide controls initially */
    .controls-overlay {
      cursor: none;
    }

    .player-container:hover .controls-overlay {
      cursor: default;
    }
  </style>
</head>
<body>
  <div class="player-container">
    <video id="videoPlayer" controls="false" preload="metadata"></video>
    
    <div class="loading-screen" id="loadingScreen">
      <div class="loading-spinner"></div>
      <div class="loading-text">Loading video...</div>
      <div class="movie-info">
        <div class="movie-title" id="loadingTitle">Movie Title</div>
        <div class="movie-details" id="loadingDetails">Preparing your movie...</div>
      </div>
    </div>

    <div class="controls-overlay" id="controlsOverlay">
      <div class="top-controls">
        <a href="javascript:history.back()" class="back-button">
          <span>‚Üê</span>
          <span>Back</span>
        </a>
        
        <div class="video-info">
          <div class="video-title" id="videoTitle">Movie Title</div>
          <div class="video-details" id="videoDetails">Genre ‚Ä¢ Year</div>
        </div>
      </div>

      <div class="center-controls" id="centerControls">
        <button class="skip-btn" id="skipBackBtn">‚è™</button>
        <button class="play-pause-btn" id="playPauseBtn">‚ñ∂</button>
        <button class="skip-btn" id="skipForwardBtn">‚è©</button>
      </div>

      <div class="bottom-controls">
        <div class="progress-container">
          <div class="progress-bar" id="progressBar">
            <div class="progress-buffered" id="progressBuffered"></div>
            <div class="progress-filled" id="progressFilled"></div>
          </div>
        </div>
        
        <div class="control-row">
          <div class="left-controls">
            <button class="control-btn" id="muteBtn">üîä</button>
            <div class="volume-container">
              <div class="volume-slider" id="volumeSlider">
                <div class="volume-filled" id="volumeFilled"></div>
              </div>
            </div>
            <div class="time-display" id="timeDisplay">0:00 / 0:00</div>
          </div>
          
          <div class="right-controls">
            <select class="quality-selector" id="qualitySelector" style="display: none;">
              <option value="auto">Auto</option>
            </select>
            <button class="control-btn" id="fullscreenBtn">‚õ∂</button>
          </div>
        </div>
      </div>
    </div>

    <div class="error-screen" id="errorScreen">
      <div class="error-icon">‚ö†Ô∏è</div>
      <div class="error-title">Playback Error</div>
      <div class="error-message" id="errorMessage">
        Unable to load the video. This could be due to network issues or an unsupported format.
      </div>
      <button class="retry-button" id="retryButton">Try Again</button>
    </div>
  </div>

  <script>
    class MoviePlayer {
      constructor() {
        this.video = document.getElementById('videoPlayer');
        this.hls = null;
        this.isPlaying = false;
        this.controlsVisible = true;
        this.controlsTimeout = null;
        this.currentTime = 0;
        this.duration = 0;
        this.volume = 1;
        this.isMuted = false;
        
        this.initializePlayer();
        this.setupEventListeners();
        this.loadMovieFromURL();
      }

      initializePlayer() {
        // Hide loading screen after a short delay if video loads quickly
        this.video.addEventListener('loadeddata', () => {
          setTimeout(() => {
            document.getElementById('loadingScreen').classList.add('hidden');
          }, 500);
        });

        // Set up HLS.js if supported
        if (Hls.isSupported()) {
          this.hls = new Hls({
            enableWorker: true,
            lowLatencyMode: false,
            backBufferLength: 90
          });
          
          this.hls.on(Hls.Events.MANIFEST_PARSED, () => {
            console.log('HLS manifest parsed');
            this.setupQualitySelector();
          });

          this.hls.on(Hls.Events.ERROR, (event, data) => {
            console.error('HLS error:', data);
            if (data.fatal) {
              this.handleError('HLS playback error: ' + data.details);
            }
          });
        }
      }

      loadMovieFromURL() {
        const urlParams = new URLSearchParams(window.location.search);
        const src = urlParams.get('src');
        const title = urlParams.get('title') || 'Unknown Movie';
        const year = urlParams.get('year') || '';
        const genre = urlParams.get('genre') || '';
        const poster = urlParams.get('poster') || '';
        const source = urlParams.get('source') || '';

        // Update UI with movie info
        document.getElementById('loadingTitle').textContent = title;
        document.getElementById('videoTitle').textContent = title;
        
        const details = [year, genre, source].filter(Boolean).join(' ‚Ä¢ ');
        document.getElementById('loadingDetails').textContent = details || 'Loading...';
        document.getElementById('videoDetails').textContent = details;

        if (!src) {
          this.handleError('No video source provided');
          return;
        }

        this.loadVideo(src);
      }

      loadVideo(src) {
        try {
          // Check if it's an HLS stream (.m3u8)
          if (src.includes('.m3u8') || src.includes('m3u8')) {
            if (this.hls) {
              this.hls.loadSource(src);
              this.hls.attachMedia(this.video);
            } else if (this.video.canPlayType('application/vnd.apple.mpegurl')) {
              // Safari native HLS support
              this.video.src = src;
            } else {
              this.handleError('HLS not supported on this browser');
              return;
            }
          } else {
            // Direct video file
            this.video.src = src;
          }

          // Set up video event listeners
          this.video.addEventListener('loadstart', () => {
            console.log('Video loading started');
          });

          this.video.addEventListener('canplay', () => {
            console.log('Video can start playing');
            document.getElementById('loadingScreen').classList.add('hidden');
          });

          this.video.addEventListener('error', (e) => {
            console.error('Video error:', e);
            this.handleError('Failed to load video');
          });

        } catch (error) {
          console.error('Load error:', error);
          this.handleError('Failed to initialize video player');
        }
      }

      setupQualitySelector() {
        if (!this.hls || !this.hls.levels) return;

        const qualitySelector = document.getElementById('qualitySelector');
        const levels = this.hls.levels;

        if (levels.length > 1) {
          qualitySelector.style.display = 'block';
          qualitySelector.innerHTML = '<option value="-1">Auto</option>';
          
          levels.forEach((level, index) => {
            const option = document.createElement('option');
            option.value = index;
            option.textContent = `${level.height}p`;
            qualitySelector.appendChild(option);
          });

          qualitySelector.addEventListener('change', (e) => {
            this.hls.currentLevel = parseInt(e.target.value);
          });
        }
      }

      setupEventListeners() {
        // Video events
        this.video.addEventListener('timeupdate', () => {
          this.updateProgress();
        });

        this.video.addEventListener('loadedmetadata', () => {
          this.duration = this.video.duration;
          this.updateTimeDisplay();
        });

        this.video.addEventListener('play', () => {
          this.isPlaying = true;
          this.updatePlayPauseButton();
        });

        this.video.addEventListener('pause', () => {
          this.isPlaying = false;
          this.updatePlayPauseButton();
        });

        this.video.addEventListener('volumechange', () => {
          this.updateVolumeDisplay();
        });

        this.video.addEventListener('ended', () => {
          this.isPlaying = false;
          this.updatePlayPauseButton();
        });

        // Control events
        document.getElementById('playPauseBtn').addEventListener('click', () => {
          this.togglePlayPause();
        });

        document.getElementById('skipBackBtn').addEventListener('click', () => {
          this.skipTime(-10);
        });

        document.getElementById('skipForwardBtn').addEventListener('click', () => {
          this.skipTime(10);
        });

        document.getElementById('muteBtn').addEventListener('click', () => {
          this.toggleMute();
        });

        document.getElementById('fullscreenBtn').addEventListener('click', () => {
          this.toggleFullscreen();
        });

        document.getElementById('retryButton').addEventListener('click', () => {
          this.retry();
        });

        // Progress bar
        document.getElementById('progressBar').addEventListener('click', (e) => {
          this.seekToPosition(e);
        });

        // Volume slider
        document.getElementById('volumeSlider').addEventListener('click', (e) => {
          this.setVolume(e);
        });

        // Mouse/touch events for controls
        this.setupControlsToggle();

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
          this.handleKeyboard(e);
        });

        // Video click to play/pause
        this.video.addEventListener('click', () => {
          this.togglePlayPause();
        });
      }

      setupControlsToggle() {
        const overlay = document.getElementById('controlsOverlay');
        let fadeTimeout;

        const showControls = () => {
          overlay.classList.add('show');
          clearTimeout(fadeTimeout);
          
          if (this.isPlaying) {
            fadeTimeout = setTimeout(() => {
              overlay.classList.remove('show');
            }, 3000);
          }
        };

        const hideControls = () => {
          if (this.isPlaying) {
            overlay.classList.remove('show');
          }
        };

        // Show controls on mouse move
        document.addEventListener('mousemove', showControls);
        document.addEventListener('touchstart', showControls);
        
        // Show controls when video is paused
        this.video.addEventListener('pause', showControls);
        this.video.addEventListener('play', () => {
          fadeTimeout = setTimeout(hideControls, 3000);
        });

        // Initially show controls
        showControls();
      }

      togglePlayPause() {
        if (this.video.paused) {
          this.video.play().catch(e => {
            console.error('Play failed:', e);
            this.handleError('Failed to play video');
          });
        } else {
          this.video.pause();
        }
      }

      skipTime(seconds) {
        this.video.currentTime = Math.max(0, Math.min(this.video.duration, this.video.currentTime + seconds));
      }

      toggleMute() {
        this.video.muted = !this.video.muted;
      }

      toggleFullscreen() {
        if (!document.fullscreenElement) {
          document.documentElement.requestFullscreen().catch(e => {
            console.error('Fullscreen failed:', e);
          });
        } else {
          document.exitFullscreen();
        }
      }

      seekToPosition(e) {
        const rect = e.target.getBoundingClientRect();
        const pos = (e.clientX - rect.left) / rect.width;
        this.video.currentTime = pos * this.video.duration;
      }

      setVolume(e) {
        const rect = e.target.getBoundingClientRect();
        const pos = (e.clientX - rect.left) / rect.width;
        this.video.volume = Math.max(0, Math.min(1, pos));
      }

      updateProgress() {
        if (this.video.duration) {
          const progress = (this.video.currentTime / this.video.duration) * 100;
          document.getElementById('progressFilled').style.width = progress + '%';
          
          // Update buffered progress
          if (this.video.buffered.length > 0) {
            const buffered = (this.video.buffered.end(0) / this.video.duration) * 100;
            document.getElementById('progressBuffered').style.width = buffered + '%';
          }
        }
        this.updateTimeDisplay();
      }

      updateTimeDisplay() {
        const current = this.formatTime(this.video.currentTime);
        const duration = this.formatTime(this.video.duration);
        document.getElementById('timeDisplay').textContent = `${current} / ${duration}`;
      }

      updatePlayPauseButton() {
        const btn = document.getElementById('playPauseBtn');
        btn.textContent = this.isPlaying ? '‚è∏' : '‚ñ∂';
      }

      updateVolumeDisplay() {
        const volumeFilled = document.getElementById('volumeFilled');
        const muteBtn = document.getElementById('muteBtn');
        
        volumeFilled.style.width = (this.video.volume * 100) + '%';
        muteBtn.textContent = this.video.muted ? 'üîá' : 'üîä';
      }

      formatTime(seconds) {
        if (isNaN(seconds)) return '0:00';
        
        const hours = Math.floor(seconds / 3600);
        const minutes = Math.floor((seconds % 3600) / 60);
        const secs = Math.floor(seconds % 60);
        
        if (hours > 0) {
          return `${hours}:${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }
        return `${minutes}:${secs.toString().padStart(2, '0')}`;
      }

      handleKeyboard(e) {
        switch(e.code) {
          case 'Space':
            e.preventDefault();
            this.togglePlayPause();
            break;
          case 'ArrowLeft':
            e.preventDefault();
            this.skipTime(-10);
            break;
          case 'ArrowRight':
            e.preventDefault();
            this.skipTime(10);
            break;
          case 'ArrowUp':
            e.preventDefault();
            this.video.volume = Math.min(1, this.video.volume + 0.1);
            break;
          case 'ArrowDown':
            e.preventDefault();
            this.video.volume = Math.max(0, this.video.volume - 0.1);
            break;
          case 'KeyF':
            e.preventDefault();
            this.toggleFullscreen();
            break;
          case 'KeyM':
            e.preventDefault();
            this.toggleMute();
            break;
        }
      }

      handleError(message) {
        console.error('Player error:', message);
        document.getElementById('loadingScreen').classList.add('hidden');
        document.getElementById('errorMessage').textContent = message;
        document.getElementById('errorScreen').style.display = 'flex';
      }

      retry() {
        document.getElementById('errorScreen').style.display = 'none';
        document.getElementById('loadingScreen').classList.remove('hidden');
        
        // Reload the page to restart everything
        window.location.reload();
      }

      destroy() {
        if (this.hls) {
          this.hls.destroy();
        }
      }
    }

    // Initialize player when page loads
    document.addEventListener('DOMContentLoaded', () => {
      const player = new MoviePlayer();
      
      // Cleanup on page unload
      window.addEventListener('beforeunload', () => {
        player.destroy();
      });
    });

    // Handle fullscreen changes
    document.addEventListener('fullscreenchange', () => {
      const btn = document.getElementById('fullscreenBtn');
      btn.textContent = document.fullscreenElement ? '‚õ∂' : '‚õ∂';
    });
  </script>
</body>
</html>
